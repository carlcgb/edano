name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Check Google Maps API key
        run: |
          if [ -z "${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}" ]; then
            echo "‚ùå VITE_GOOGLE_MAPS_API_KEY is not set in GitHub Secrets"
            exit 1
          fi
          echo "‚úÖ VITE_GOOGLE_MAPS_API_KEY is configured from GitHub Secrets"
          API_KEY_PREVIEW="${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}"
          echo "üîë API Key preview: ${API_KEY_PREVIEW:0:15}..." 

      - name: Setup environment file
        run: |
          echo "üîç Verifying API key is available..."
          if [ -z "$VITE_GOOGLE_MAPS_API_KEY" ]; then
            echo "‚ùå ERROR: VITE_GOOGLE_MAPS_API_KEY is not available"
            echo "‚ùå This means the secret is not set in GitHub Secrets"
            exit 1
          fi
          echo "‚úÖ API key is available (length: ${#VITE_GOOGLE_MAPS_API_KEY} chars)"
          echo "üîë API key preview: ${VITE_GOOGLE_MAPS_API_KEY:0:20}..."
          echo "üìù Creating .env.production file..."
          echo "VITE_GOOGLE_MAPS_API_KEY=$VITE_GOOGLE_MAPS_API_KEY" > .env.production
          echo "‚úÖ .env.production created"
          cat .env.production | sed 's/VITE_GOOGLE_MAPS_API_KEY=\(.\{20\}\).*/VITE_GOOGLE_MAPS_API_KEY=\1.../' 
        env:
          VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}

      - name: Build
        run: |
          echo "=========================================="
          echo "üîç PRE-BUILD VERIFICATION"
          echo "=========================================="
          if [ -z "$VITE_GOOGLE_MAPS_API_KEY" ]; then
            echo "‚ùå CRITICAL ERROR: VITE_GOOGLE_MAPS_API_KEY is EMPTY!"
            echo "‚ùå The secret does not exist or is empty in GitHub Secrets"
            echo "‚ùå Go to: https://github.com/carlcgb/edano/settings/secrets/actions"
            echo "‚ùå Create secret: VITE_GOOGLE_MAPS_API_KEY = AIzaSyAe4Gb3UubLAgUr6rqgh3B4MLPsuXxSep4"
            exit 1
          fi
          echo "‚úÖ API key is set"
          echo "üîë API key length: ${#VITE_GOOGLE_MAPS_API_KEY} chars"
          echo "üîë API key starts with: ${VITE_GOOGLE_MAPS_API_KEY:0:20}..."
          echo "üîë API key ends with: ...${VITE_GOOGLE_MAPS_API_KEY: -10}"
          echo ""
          echo "=========================================="
          echo "üì¶ STARTING BUILD"
          echo "=========================================="
          npm run build
          echo ""
          echo "=========================================="
          echo "üîç POST-BUILD VERIFICATION"
          echo "=========================================="
          echo "Searching for API key in built files..."
          JS_FILES=$(find dist/assets -name "*.js" -type f 2>/dev/null | head -3)
          if [ -z "$JS_FILES" ]; then
            echo "‚ö†Ô∏è No JS files found in dist/assets"
          else
            for file in $JS_FILES; do
              echo "Checking: $file"
              if grep -q "AIzaSy" "$file" 2>/dev/null; then
                echo "‚úÖ FOUND API KEY in $file"
                grep -o "AIzaSy[^\"]*" "$file" | head -1 | sed 's/\(.\{20\}\).*/\1.../'
              elif grep -q '"undefined"' "$file" 2>/dev/null || grep -q "undefined" "$file" 2>/dev/null; then
                echo "‚ùå FOUND 'undefined' in $file - API key was NOT injected!"
                echo "This means the build failed to inject the API key"
                exit 1
              else
                echo "‚ö†Ô∏è API key pattern not found in $file"
              fi
            done
          fi
          echo "=========================================="
        env:
          VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}

      - name: Check Cloudflare secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚ùå CLOUDFLARE_API_TOKEN is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "‚ùå CLOUDFLARE_ACCOUNT_ID is not set"
            exit 1
          fi
          echo "‚úÖ Cloudflare secrets are configured"

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'edano-podcast'
          directory: './dist'
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}